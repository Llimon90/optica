<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punto de Venta - √ìpticaFlow</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <button class="mobile-menu-btn d-none" onclick="toggleSidebar()">
        <span class="material-icons">menu</span>
    </button>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">OF</div>
                <span class="logo-text">√ìpticaFlow</span>
            </div>
        </div>
        <nav class="sidebar-nav">
            <a href="pacientes.html"><span class="material-icons">person</span> <span>Pacientes</span></a>
            <a href="consultas.html"><span class="material-icons">visibility</span> <span>Consultas</span></a>
            <a href="inventario.html"><span class="material-icons">inventory_2</span> <span>Inventario</span></a>
            <a href="pos.html" class="active"><span class="material-icons">point_of_sale</span> <span>Punto de Venta</span></a>
            <a href="reportes.html"><span class="material-icons">analytics</span> <span>Reportes</span></a>
        </nav>
    </div>

    <div class="main-content">
        <div class="page-header">
            <h1 class="page-title">üí∞ Punto de Venta</h1>
            <p class="page-subtitle">Procese ventas y emita tickets de forma r√°pida</p>
        </div>

        <div class="page-content">
            <div class="pos-grid">
                <!-- Secci√≥n de entrada de datos -->
                <div class="pos-section">
                    <div class="pos-section-header">
                        <h2 class="pos-section-title">
                            <span class="material-icons">shopping_cart</span>
                            Detalles de la Venta
                        </h2>
                    </div>
                    <div class="pos-section-body">
                        <!-- Informaci√≥n del Paciente -->
                        <div class="patient-info">
                            <h3 style="margin-bottom: var(--space-sm);">Informaci√≥n del Paciente</h3>
                            <div class="form-row">
                                <label for="paciente_pos">Seleccionar Paciente:</label>
                                <select id="paciente_pos" class="form-control">
                                    <option value="">Cargando pacientes...</option>
                                    <!-- Las opciones se cargan din√°micamente -->
                                </select>
                                <button type="button" class="btn btn-secondary" onclick="seleccionarPaciente()">Seleccionar</button>
                            </div>
                            <div class="patient-meta">
                                <div class="patient-meta-item">
                                    <span class="material-icons">person</span>
                                    <span>Paciente: <strong id="current_patient_name">-- Ninguno --</strong></span>
                                </div>
                                <div class="patient-meta-item">
                                    <span class="material-icons">visibility</span>
                                    <span>Receta: <strong id="current_receta">No asociada</strong></span>
                                </div>
                            </div>
                        </div>

                        <!-- A√±adir √çtems -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <span class="material-icons">add_circle</span>
                                    A√±adir √çtem (Producto o Servicio)
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="form-label">√çtem:</label>
                                    <input type="text" id="item_name" class="form-control" placeholder="Nombre/C√≥digo de Montura, Lente, Servicio">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Precio Unitario:</label>
                                    <input type="number" id="item_price" class="form-control" value="0.00" min="0" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Cantidad:</label>
                                    <input type="number" id="item_qty" class="form-control" value="1" min="1">
                                </div>
                                <button type="button" class="btn btn-primary btn-block" onclick="addItem()">
                                    <span class="material-icons">add_shopping_cart</span>
                                    A√±adir a la Orden
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n de resumen y pago -->
                <div class="pos-section">
                    <div class="pos-section-header">
                        <h2 class="pos-section-title">
                            <span class="material-icons">receipt</span>
                            Orden y Cobro
                        </h2>
                    </div>
                    <div class="pos-section-body">
                        <!-- Tabla de √≥rdenes -->
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>√çtem</th>
                                        <th>Cant.</th>
                                        <th>Precio</th>
                                        <th>Total</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="order_items_body">
                                    <!-- Los √≠tems de la orden se cargan aqu√≠ -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Totales -->
                        <div class="totals-section">
                            <div class="total-row">
                                <span>Subtotal:</span>
                                <span id="subtotal_display">$0.00</span>
                            </div>
                            <div class="total-row">
                                <span>Descuento (%):</span>
                                <div class="d-flex align-center gap-1">
                                    <input type="number" id="discount_input" class="form-control" value="0" min="0" max="100" style="width: 80px;" oninput="updateTotals()">
                                    <span>%</span>
                                </div>
                            </div>
                            <div class="total-row tax-row">
                                <span>Impuestos (IVA 16%):</span>
                                <span id="tax_display">$0.00</span>
                            </div>
                            <div class="total-row grand-total">
                                <span>TOTAL A PAGAR:</span>
                                <span id="grand_total_display">$0.00</span>
                            </div>
                        </div>

                        <!-- Secci√≥n de pago -->
                        <form id="paymentForm">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <span class="material-icons">payment</span>
                                        Finalizar Transacci√≥n
                                    </h3>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label class="form-label">M√©todo de Pago:</label>
                                        <select id="payment_method" class="form-control">
                                            <option value="efectivo">Efectivo</option>
                                            <option value="tarjeta">Tarjeta de Cr√©dito/D√©bito</option>
                                            <option value="transferencia">Transferencia Electr√≥nica</option>
                                            <option value="cheque">Cheque</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-success btn-block btn-lg">
                                        <span class="material-icons">check_circle</span>
                                        Procesar Venta y Emitir Factura
                                    </button>
                                </div>
                            </div>
                        </form>

                        <button type="button" class="btn btn-warning btn-block" onclick="printTicket()">
                            <span class="material-icons">print</span>
                            Imprimir √öltimo Ticket
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="pos_script.js?v=3"></script>
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('mobile-open');
        }

        // FUNCI√ìN CORREGIDA - debe llamarse seleccionarPaciente (no buscarPacientePOS)
        function seleccionarPaciente() {
            const selectPaciente = document.getElementById('paciente_pos');
            const pacienteId = selectPaciente.value;
            const pacienteNombre = selectPaciente.options[selectPaciente.selectedIndex]?.dataset.patientName || 
                                 selectPaciente.options[selectPaciente.selectedIndex]?.textContent;
            
            if (pacienteId) {
                document.getElementById('current_patient_name').textContent = pacienteNombre;
                document.getElementById('current_receta').textContent = 'Paciente seleccionado';
                showNotification(`‚úÖ Paciente "${pacienteNombre}" seleccionado`);
            } else {
                showNotification('‚ùå Por favor, seleccione un paciente', 'error');
            }
        }

        // Funci√≥n showNotification para el script interno
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                background: ${type === 'error' ? '#ef4444' : '#10b981'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 10000;
                font-weight: 500;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        }

        window.addEventListener('resize', function() {
            const mobileBtn = document.querySelector('.mobile-menu-btn');
            if (window.innerWidth <= 640) {
                mobileBtn.classList.remove('d-none');
            } else {
                mobileBtn.classList.add('d-none');
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            window.dispatchEvent(new Event('resize'));
        });
    </script>
</body>
</html>